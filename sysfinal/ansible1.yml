---
# Write your playbook below.
# Replace these contents with the tasks you'd like to complete and the modules you need.
# For help getting started, check out https://www.redhat.com/en/topics/automation/what-is-an-ansible-playbook
# Ansible playbook to automate the setup of a Website deployment on rocky linux server

# Disable root SSH login for security
#fukass comment
- name: Website deployment automation script - Disable Root SSH Login
  hosts: 127.0.0.1
  connection: local
  become: true
  tasks:
   - name: PermitRootLogin set to no
     ansible.builtin.lineinfile:
       path: /etc/ssh/sshd_config
       regexp: '^#?PermitRootLogin'
       line: 'PermitRootLogin no'
       state: present
   - name: Restart sshd
     ansible.builtin.service:
       name: sshd
       state: restarted

- name: Website deployment automation script - Firewall Ports and Reload
  hosts: 127.0.0.1
  connection: local
  become: true
  tasks:
   - name: Enable ports
     ansible.posix.firewalld:
       port: "{{ item }}/tcp"
       permanent: true
       state: enabled
     loop:
      - 80
      - 443
   - name: Reload firewalld
     ansible.builtin.service:
       name: firewalld
       state: reloaded
       enabled: true

- name: Website deployment automation script - Install and Enable HTTPD
  hosts: 127.0.0.1
  connection: local
  become: true
  tasks:
    - name: Install httpd package
      ansible.builtin.yum:
        name: httpd
        state: present
    - name: 
      ansible.builtin.service:
        name: httpd
        state: started
        enabled: true

- name: Website deployment automation script - Install and Enable MySQL and MariaDB
  hosts: 127.0.0.1
  connection: local
  become: true
  tasks:
    - name: Install pip3
      ansible.builtin.package:
        name:
          - python3-pip
        state: present
    - name: Install PyMySQL dependency
      ansible.builtin.pip:
        name: PyMySQL
        executable: pip3
    - name: Please use python so i can sleep
      ansible.builtin.set_fact:
       ansible_python_interpreter: /usr/bin/python3
    - name: Install MySQL server package
      ansible.builtin.yum:
        name: mysql-server
        state: present
    - name: Start and enable MySQL service
      ansible.builtin.service:
        name: mysqld
        state: started
        enabled: true

- name: Website deployment automation script - MySQL Secure Installation
  hosts: 127.0.0.1
  connection: local
  become: true
  vars:
    mysql_root_password: "SavCone255!"
  tasks: 
    - name: Set MySQL root password
      mysql_user:
        name: root
        host: localhost
        password: "{{ mysql_root_password }}"
        login_unix_socket: /var/lib/mysql/mysql.sock
        state: present
    - name: Remove Anon Users
      mysql_user:
        name: ''
        host_all: yes
        state: absent
        login_user: root
        login_password: "{{ mysql_root_password }}"
    - name: Disable remote root login
      mysql_user:
        name: root
        host: '%'
        state: absent
        login_user: root
        login_password: "{{ mysql_root_password }}"
    - name: Remove test database
      mysql_db:
        name: test
        state: absent
        login_user: root
        login_password: "{{ mysql_root_password }}"

- name: We showin off tha SQL with this one (creating the database)
  hosts: 127.0.0.1
  connection: local
  become: true
  vars:
    db_name: "lamp_stack_delicious_and_stuff"
    db_user: "cuck"
    db_pass: "cuckchair"
    web_root: "/var/www/html"
    mysql_root_password: "SavCone255!"
  tasks:
    - name: Create database pretty please and stuff
      mysql_db:
        name: "{{ db_name }}"
        state: present
        login_user: root
        login_password: "{{ mysql_root_password }}"
    - name: creating da user for database
      mysql_user:
        name: "{{ db_user }}"
        password: "{{ db_pass }}"
        priv: "{{ db_name }}.*:ALL"
        state: present
        login_user: root
        login_password: "{{ mysql_root_password }}"
    - name: Create guestbook table
      mysql_query:
        login_user: root
        login_password: "{{ mysql_root_password }}"
        login_db: "{{ db_name }}"
        query: |
          CREATE TABLE IF NOT EXISTS guestbook (
              id INT AUTO_INCREMENT PRIMARY KEY,
              name VARCHAR(100),
              message TEXT,
              created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
          );
    - name: Copy index.php
      copy:
        src: index.php
        dest: "{{ web_root }}/index.php"
    - name: Copy save.php
      copy:
        src: save.php
        dest: "{{ web_root }}/save.php"

- name: Website deployment automation script - Move basicwebpage.html from github clone to /var/www/html/
  hosts: 127.0.0.1
  connection: local
  become: true
  tasks:
    - name: Moving basicwebpage.html to /var/www/html/
      ansible.builtin.copy:
        src: /home/champuser/Sys-255-Final-Project/sysfinal/basicwebpage.html
        dest: /var/www/html/index.html
        mode: '0644'